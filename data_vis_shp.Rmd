---
title: "data_vis_shp"
author: "Rae Fuhrman"
date: "2/20/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages and data}

library(sf)
library(tmap)
library(leaflet)
library(ggrepel)
library(ggspatial)
library(RColorBrewer)
library(fasterize)
library(raster)
library(colorspace)

annual_swh <- read_sf ("244-extra", layer = "vbl_ssh_allreg_annPolygon") #244-extra is the folder it's in within this working directory
harvest_beds <- read_sf("MAN_CA_KelpAdmin", layer = "MAN_CA_KelpAdmin") %>% 
  st_transform(crs = 4326)

```
Simple feature collection with 63623 features and 1 field
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: -179.998 ymin: 16.96665 xmax: 179.998 ymax: 63.03335
epsg (SRID):    4326
proj4string:    +proj=longlat +datum=WGS84 +no_defs

```{r plot and visualize}

plot(annual_swh)
range(annual_swh$ann_ssh) #0.09 3.12, must be in meters

## Set up a raster "template" for a 1/12 degree grid
?extent
ext <- extent(-179.998, 179.998, 16.96665, 63.03335)
gridsize <- 0.083
r <- raster(ext, res=gridsize)

## Rasterize the shapefile
#rr <- rasterize(annual_swh, r, field = "ann_ssh") #this took like 5 minutes
#rr

## Plot raster
#plot(rr, box = FALSE) #scale is 0-60,000... may have multiplied everything by 10,000 i.e. SWH of 6 = 60,000
#axes = FALSE

##make and plot raster with fasterize -- MUCH FASTER
fr <- fasterize(annual_swh, r, field = "ann_ssh") #field is the value for each of the polygons rasterized; default fun = "last" though I'm not sure exactly which one we want
plot(fr) #different results than rasterize. different scale entirely.


##make cropped vector for southern california to rasterize; seems easier to crop the vector first rather than cropping the raster after
crop_annual <- st_crop(annual_swh, c(xmin=-123, xmax=-118, ymin=32, ymax=38)) #look up exact bounding box from arpa-e

ext1 <- extent(-123, -118, 32, 38)
gridsize1 <- 0.083
r1 <- raster(ext1, res=gridsize1)

crop_socal_ras <- fasterize(annual_swh, r1, field = "ann_ssh") #used non-cropped vector with new cropped raster
crop_socal_ras
#class       : RasterLayer 
#dimensions  : 72, 60, 4320  (nrow, ncol, ncell)
#resolution  : 0.083, 0.083  (x, y)
#extent      : -123, -118.02, 32.024, 38  (xmin, xmax, ymin, ymax)
plot(crop_socal_ras)


crop_socal_ras2 <- fasterize(crop_annual, r1, field = "ann_ssh") #used cropped vector and new cropped raster; this method appears identical
crop_socal_ras2
#class       : RasterLayer 
#dimensions  : 72, 60, 4320  (nrow, ncol, ncell)
#resolution  : 0.083, 0.083  (x, y)
#extent      : -123, -118.02, 32.024, 38  (xmin, xmax, ymin, ymax)
plot(crop_socal_ras2)

```


```{r visualize with tmap}

crop_socal_ras2@crs

pal <- choose_palette()

##map with the cropped vector
annual_map <- tm_shape(crop_annual) +
  tm_polygons("ann_ssh", title = "Significant Wave Heights in southern California",
              palette = "RdYlBu") +
  tm_layout(bg.color = "navyblue", 
            legend.position = c("right","top"),
            legend.text.color = "white", 
            legend.text.size = 0.5) 
  #tm_shape(islands) +
  #tm_fill("darkgreen")
annual_map

##map with the cropped raster -- USE FOR HEATMAP
annual_map2 <- tm_shape(crop_socal_ras2) +
  tm_raster("layer", title = "Significant Wave Heights in southern California") +
  tm_layout(bg.color = "navyblue", 
            legend.position = c("right","top"),
            legend.text.color = "white", 
            legend.text.size = 0.5)
annual_map2

  #tm_shape(islands) +
  #tm_fill("ann_ssh")
annual_map2
#output is smoother without the individual polygons
?tm_raster

#tmap_save(sst_map, "sst.png", height=5)

```

add historic kelp beds layer and figure out how to overlay them (maybe?) such that the attributes remain -- want to find the intersections of each swh polygon with kelp bed polygon and only include this data. st_intersection?
```{r}

beds_swh <- annual_swh %>% 
  st_intersection(harvest_beds)
plot(beds_swh) 
# so this worked but we still probably want to take a mean of the swh in each bed and make new columns for that so that we have one clickable area (each harvest bed) that averages the swh polygons that intersect.  


ggplot(beds_swh)+
  geom_sf(data = ca_counties, fill = "gray90", color = "gray80", size = 0.2)+
  geom_sf(aes(fill = Region), color = "NA")+
  scale_fill_manual(values = c("darkolivegreen2", "darkolivegreen", "gold2"))+
  coord_sf(xlim = c(-121, -119), ylim= c(33.5, 35.5))+ #trial and error, West is negative, cropped to area

beds_swh2 <- st_intersection(annual_swh, harvest_beds)#clip swh polygons to bounds of harvest_beds polygons
#both codes do the same thing

```


Some plotting stuff that didn't work but I'm a hoarder
```{r}
#CA<-readOGR("244-extra", layer="california_county_shape_file") # read the CA state boundary shapefile

#gplot(crop_socal_ras2) +  # will eventually change this to plot(kelploss_ann) but keeping it this way to test)
 # geom_raster(aes(fill=factor(value),alpha=0.8)) +
  #scale_fill_viridis_d(na.value = "white")+
  #geom_polygon(data=CA, aes(x=lon, y = lat),
   #            fill="gray90",color="grey50", size=1)+
  #coord_equal()
```


